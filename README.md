# Large backup tools

Tools involved in copying large amounts of data (~500TB) to an LTFS-backed remote store.

Constraints

- No more than 100,000 inodes / TiB
- rsync
- Network dropouts are likely
- Reading metadata on the remote is OK, but random-reading file contents is very slow

Strategy

- Get list of files on ark with their sizes `sudo find . -type f -printf "%s\t%P\n" > list_of_files.tsv`
- Get list of directories to zip up, and files to not zip up, in order to get under 100k inodes/TiB limit
  - See `choose_zips.py`
  - `./choose_zips.py ../list_of_files.tsv --zip ../to_zip.txt --nozip ../not_to_zip.txt --total`
- Use [fpart](https://github.com/martymac/fpart) to split `not_to_zip.txt` into 100GB rsync jobs
  - Don't use fpsync directly, to handle drops
  - ? `fpart -s 100000000000 -i $SIZES_DIR/not_to_zip.txt -o $SIZES_DIR/parts/part`, in top `ark:/data/fs1` directory
- Script rsyncing those parts a few at a time
  - See `rsync_all.py`
- Zip up every `to_zip.txt` directory and put in place on remote
  - See `zip_all.py`
    - N.B. This is extremely slow.

## choose_zip

Python script for determining which directories to zip up to make total files per TiB come under a particular threshold.
Requires `tqdm` and `networkx`.

Takes a tab separated value file (or pipe) like where each row has the format `path/to/file<TAB><size_bytes>`, e.g. as generated by

```sh
find . -type f -printf "%P\t%s\n"
```

and reconstructs the file hierarchy.
Then it descends into the hierarchy.
Subtrees with fewer files per TiB than a given threshold are skipped.
Subtrees whose total size is less than a given threshold are output and then skipped.

Motivation: some backup targets perform poorly or restrict dumps with lots of small files.
This script allows you to list directories which are good candidates for zipping up,
so that they can be ignored in your first dump, and then zipped and sync separately.

### Usage

```_choose_zip
usage: choose_zip.py [-h] [-t [TOTAL]] [-z MAX_ZIP_SIZE] [-l LIMIT_PER_TIB] [-P]
                   [input] [output]

positional arguments:
  input                 input file (empty or - to use stdin) with lines of
                        format `{filename}\t{n_bytes}`
  output                output file (empty or - to use stdout)

optional arguments:
  -h, --help            show this help message and exit
  -t [TOTAL], --total [TOTAL]
                        Total number of lines expected to add to graph, for
                        progress-reporting purposes. If `input` is a path AND
                        `total` is given without a value, the input file's
                        lines are counted with `wc -l` before processing.
  -z MAX_ZIP_SIZE, --max-zip-size MAX_ZIP_SIZE
                        Only directories whose contents are smaller than this
                        will be yielded, default 100.00GiB. Understands SI and
                        IEEE prefixes; bits and Bytes (default).
  -l LIMIT_PER_TIB, --limit-per-TiB LIMIT_PER_TIB
                        Directories with fewer descendants per tebibyte than
                        this will not be descended into, default 100000
  -P, --no-progress     Do not show progress bars
```

## rsync_all

N.B. We needed finer-grained progress information than this approach could give us.
Because we needed fewer parallel jobs than initially anticipated,
we went with a combination of `deal.py` and `rsync_list.py`.

Parallelise a number of rsync jobs based on file lists generated by `fpart`.
Note that the default arguments are tuned for the
University of Cambridge High Performance Computing Service Research Cold Store
and may not be appropriate for your use case.

### Usage

```_rsync_all
usage: rsync_all.py [-h] [--jobs JOBS] [--options OPTIONS]
                    [--default-options DEFAULT_OPTIONS] [--passfile PASSFILE]
                    parts source target

positional arguments:
  parts                 Directory containing fpart-generated file lists
  source                Source directory which listed files are in
  target                Target directory to copy listed files into

optional arguments:
  -h, --help            show this help message and exit
  --jobs JOBS, -j JOBS  Number of jobs to run in parallel (default 5)
  --options OPTIONS, -o OPTIONS
                        rsync options to use
  --default-options DEFAULT_OPTIONS, -d DEFAULT_OPTIONS
                        If explicit rsync options are given, also use default
                        options (--archive --quiet --whole-file --size-only
                        --inplace --rsh "ssh -T -x -o Compression=no -c
                        aes128-gcm@openssh.com")
  --passfile PASSFILE, -p PASSFILE
                        Absolute path to file containing SSH password. Do not
                        use unless absolutely necessary.
```

## deal

Given a directory containing a lot of files, create N new directories,
dealing the contents of the first directory out into the new directories as symlinks.

```_deal
usage: deal.py [-h] original output n

positional arguments:
  original    dir containing original files
  output      path to which a period and a number will be added, which will be
              a directory created and filled with symlinks pointing to the
              original files
  n           number of dirs to deal into

optional arguments:
  -h, --help  show this help message and exit
```

## rsync_list

Like `rsync_all`, but in serial, with `--info=progress2` by default.

### Usage

```_rsync_list
usage: rsync_list.py [-h] [--options OPTIONS]
                     [--default-options DEFAULT_OPTIONS] [--passfile PASSFILE]
                     parts source target

positional arguments:
  parts                 Directory containing fpart-generated file lists
  source                Source directory which listed files are in
  target                Target directory to copy listed files into

optional arguments:
  -h, --help            show this help message and exit
  --options OPTIONS, -o OPTIONS
                        rsync options to use
  --default-options DEFAULT_OPTIONS, -d DEFAULT_OPTIONS
                        If explicit rsync options are given, also use default
                        options (--archive --info=progress2 --whole-file
                        --size-only --inplace --rsh "ssh -T -x -o
                        Compression=no -c aes128-gcm@openssh.com")
  --passfile PASSFILE, -p PASSFILE
                        Absolute path to file containing SSH password. Do not
                        use unless absolutely necessary.
```
